## iTop 的建模逻辑

CMDB 工具本质上应该提供一种建模的工具，能够快速并且恰当的描述 IT 基础设施。那么，iTop 是如何建模的呢？和其他工具又有什么区别呢？

### 面向对象建模

假设我们要管理服务器和网络设备，在没有 CMDB 的时候，我们会怎么管理呢？比如用 Excel，可能会为服务器和网络设备各建一个 Sheet，然后做一个类似 [@tbl:excel-server]，[@tbl:excel-networkdevice] 那样的表格。

|序列号|资产号|主机名|机房|机柜|状态|负责人|CPU|内存|OS|
|---|---|---|---|---|---|---|--|---|----|
|XX|XX|app-01|BX|A-01|使用中|张三|8|32|CentOS 7|

: 用 Excel 管理服务器 {#tbl:excel-server}

|序列号|资产号|主机名|机房|机柜|状态|负责人|类型|IOS|
|-----|-----|-----|-----|----|----|-----|----|---|
|YY|YY|sw-01|BX|A-01|使用中|李四|交换机|C2500|

: 用 Excel 管理网络设备 {#tbl:excel-networkdevice}

可以看到，它们都关注序列号，资产号，主机名，机房，机柜这些属性。如果将来有更多类似设备需要管理，比如磁带库，存储系统，需要给他们都分别建表，重复录入这些属性。在一些 CMDB 工具，比如 bk-cmdb 中，用的正是这种方式。

而 iTop 用的是面向对象的方式给他们建模，将这些对象的共同属性提取出来，放到一个父类里，就能够大大减少模型定义的重复工作。以服务器和网络设备为例，iTop 的继承关系如 [@fig:itop-inherit]。

```{#fig:itop-inherit .plot:dot caption="iTop 服务器网络设备继承关系"}
digraph iTopInherit {
	node [shape="record"];
	rankdir = "LR";

	functionalci [label="FunctionalCI|<id>id|name|description|org_id|move2production|contacts_list|..."];
	physicaldevice [label="PhysicalDevice|<id>id|serialnumber|asset_number|location_id|status|brand_id|model_id|purchase_date|end_of_warranty|..."];
	connectableci [label="ConnectableCI|<id>id|networkdevice_list|physicalinterface_list"];
	datacenterdevice [label="DatacenterDevice|<id>id|rack_id|enclosure_id|nb_u|powerA_id|powerB_id|..."];
	server [label="Server|<id>id|cpu|ram|osfamily_id|osversion_id|..."];
	networkdevice [label="NetworkDevice|<id>id|ram|iosversion_id|..."];

	functionalci -> physicaldevice -> connectableci -> datacenterdevice -> {server,networkdevice};
}
```

### 模型描述方式
仍然以 bk-cmdb  作为对比，bk-cmdb 支持在界面上创建模型及其属性，而 iTop 是通过插件 XML 来新增自己的模型，这两种方式孰优孰劣呢？我认为 iTop 的方式更好一些。理由主要是以下三点：

1. 插件方式描述模型，通过代码及注释，很容易记录模型的设计理念，通过代码提交记录还能记录变更历史
2. 插件方式很容易在不同环境间迁移模型，界面操作看似简单，但是迁移似乎很不方便
3. 插件方式非常灵活，扩展能力很强，表现力远远优于界面定义。比如，iTop 插件很容易定义一些自动计算的属性，很容易实现对象创建删除前后的额外操作